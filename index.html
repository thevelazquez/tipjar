<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EdsVel — Tip Jar</title>
  <style>
    /* (same styling as your current mock, slightly compacted for readability) */
    body{font-family:Arial,sans-serif;background:#fafafa;margin:0;padding:0;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;text-align:center}
    .profile-pic{width:120px;height:120px;border-radius:50%;object-fit:cover;margin-bottom:1rem;border:3px solid #ccc}
    h1{margin:.5rem 0;font-size:1.8rem}
    .email{color:#555;margin-bottom:1rem;font-size:.9rem}
    .quick-buttons{display:flex;gap:.5rem;margin-bottom:1rem}
    .quick-button{background:#e0e0ff;border:none;padding:.6rem 1rem;border-radius:6px;cursor:pointer;font-size:1rem}
    .quick-button:hover{background:#c5c5ff}
    .custom-display{font-size:2rem;font-weight:700;margin-bottom:1rem}
    .keypad{display:grid;grid-template-columns:repeat(3,70px);gap:.5rem;justify-content:center;margin-bottom:1rem}
    .key{background:#f0f0f0;border:none;padding:1rem;font-size:1.2rem;border-radius:6px;cursor:pointer}
    .key:hover{background:#ddd}
    .tip-button{background:#635bff;color:#fff;border:none;padding:1rem 2rem;border-radius:8px;font-size:1.1rem;cursor:pointer}
    .footer{font-size:.8rem;color:#aaa;margin-top:1.5rem}
    /* modal style for payment card */
    .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);visibility:hidden;opacity:0;transition:opacity .18s ease}
    .modal.show{visibility:visible;opacity:1}
    .modal-card{background:#fff;padding:1rem 1.25rem;border-radius:10px;min-width:320px;max-width:420px;text-align:left}
    .modal-row{margin-bottom:.75rem}
    #card-element{padding:.75rem;border:1px solid #e6e6e6;border-radius:6px}
  </style>
  <!-- Stripe.js - replace the publishable key placeholder in the script initialization below -->
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <img class="profile-pic" src="images/Profile pic.jpg" alt="Profile" />
  <h1>Edgardo</h1>
  <div class="email">Business inquiries: <a href="mailto:your@email.com">edv9298@email.com</a></div>

  <div class="quick-buttons">
    <button class="quick-button" onclick="setAmount(1)">$1</button>
    <button class="quick-button" onclick="setAmount(5)">$5</button>
    <button class="quick-button" onclick="setAmount(10)">$10</button>
    <button class="quick-button" onclick="showCustom()">Custom</button>
  </div>

  <div id="custom-area" style="display:none;">
    <div class="custom-display" id="custom-display">$0</div>
    <div class="keypad">
      <button class="key" onclick="appendNumber(1)">1</button>
      <button class="key" onclick="appendNumber(2)">2</button>
      <button class="key" onclick="appendNumber(3)">3</button>
      <button class="key" onclick="appendNumber(4)">4</button>
      <button class="key" onclick="appendNumber(5)">5</button>
      <button class="key" onclick="appendNumber(6)">6</button>
      <button class="key" onclick="appendNumber(7)">7</button>
      <button class="key" onclick="appendNumber(8)">8</button>
      <button class="key" onclick="appendNumber(9)">9</button>
      <button class="key" onclick="deleteNumber()">⌫</button>
      <button class="key" onclick="appendNumber(0)">0</button>
      <button class="key" onclick="confirmCustom()">⏎</button>
    </div>
  </div>

  <button class="tip-button" id="donateBtn">Send Tip</button>

  <div class="footer">Secure payments processed via Stripe</div>

  <!-- Modal for card entry -->
  <div id="payModal" class="modal">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-row"><strong>Pay</strong></div>
      <div class="modal-row">Amount: <span id="modal-amount">$0</span></div>
      <div class="modal-row" id="card-element"></div>
      <div class="modal-row" id="card-errors" role="alert" style="color:#d9534f"></div>
      <div style="display:flex;gap:.5rem;justify-content:flex-end">
        <button onclick="closeModal()" style="padding:.5rem 1rem;border-radius:6px;border:1px solid #ccc;background:#fff">Cancel</button>
        <button id="confirmPay" style="padding:.5rem 1rem;border-radius:6px;border:none;background:#635bff;color:#fff">Pay</button>
      </div>
    </div>
  </div>

  <script>
    // Replace this with your Stripe publishable key BEFORE deploying
    const STRIPE_PUBLISHABLE_KEY = 'pk_test_51RuOJXIe3Ht0EENrP6ARVfHCCHiUsk31gqKtTXWfIJO0OBck2jyER5ZlY4nrdgYSpK26HhUsvWYNprxHiBkTNbDj00R9ZDn5iE';
    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

    // Stripe Elements setup (we'll mount the card element when needed)
    let elements = stripe.elements();
    let cardElement;

    let amountValue = 0; // dollars (can be integer or decimal)

    const donateBtn = document.getElementById('donateBtn');
    donateBtn.addEventListener('click', initDonation);

    function setAmount(value){ amountValue = value; startIntent(amountValue); }
    function showCustom(){ document.getElementById('custom-area').style.display='block'; amountValue=0; updateDisplay(); }
    function appendNumber(n){
      const display = document.getElementById('custom-display');
      //set "cur" to the presented value while removing the dollar sign
      let cur = display.textContent.replace('$','') || '0';
      //don't do anything if cur is equal to 0 (?)
      if(cur === '0') cur = '';
      //append the inserted number to the end of the string and then multiply it by 10 to shift the digits to their correct place
      cur = cur + n.toString();
      amountValue = parseFloat(cur)*10
      updateDisplay();
    }
    function deleteNumber(){
      const display = document.getElementById('custom-display');
      let cur = display.textContent.replace('$','') || '0';
      cur = cur.replace('.','');
      cur = cur.slice(0,-1);
      if(!cur) { amountValue = 0; updateDisplay(); return; }
      let dollars = (parseInt(cur)/100).toFixed(2);
      amountValue = parseFloat(dollars);
      updateDisplay();
    }
    function confirmCustom(){ if(amountValue>0) startIntent(amountValue); }
    function updateDisplay(){ document.getElementById('custom-display').textContent = `$${amountValue.toFixed(2)}`; }

    // modal helpers
    function openModal(){ document.getElementById('payModal').classList.add('show'); }
    function closeModal(){ document.getElementById('payModal').classList.remove('show'); }

    async function initDonation(){
      if(!amountValue || amountValue <= 0){ alert('Please pick or enter an amount'); return; }
      // Create PaymentIntent on server (Netlify function)
      try{
        await startIntent(amountValue);
      }catch(err){ console.error(err); alert('Error initiating donation'); }
    }

    async function startIntent(amount){
      // call Netlify function to create PaymentIntent
      const res = await fetch('/.netlify/functions/create-payment-intent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: Math.round(amount * 100) })
      });
      const data = await res.json();
      if(data.error){ throw new Error(data.error); }
      const clientSecret = data.client_secret;

      // show modal and mount card element if not yet mounted
      document.getElementById('modal-amount').textContent = `$${amount.toFixed(2)}`;
      openModal();
      if(!cardElement){
        const style = { base: { fontSize: '16px', color: '#32325d', '::placeholder': { color: '#aab7c4' } } };
        cardElement = elements.create('card', { style });
        cardElement.mount('#card-element');
        cardElement.on('change', function(event){ document.getElementById('card-errors').textContent = event.error ? event.error.message : ''; });
      }

      // attach handler to confirm button
      const confirmBtn = document.getElementById('confirmPay');
      confirmBtn.onclick = async function(){
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Processing...';
        const result = await stripe.confirmCardPayment(clientSecret, { payment_method: { card: cardElement } });
        if(result.error){ document.getElementById('card-errors').textContent = result.error.message; confirmBtn.disabled=false; confirmBtn.textContent='Pay'; }
        else if(result.paymentIntent && result.paymentIntent.status === 'succeeded'){
          closeModal();
          showThankYou();
        }
      };
    }

    function showThankYou(){
      document.body.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh"><h2>Thank you!</h2><p>Your tip of $${amountValue.toFixed(2)} was received.</p></div>`;
    }
  </script>
</body>

</html>
